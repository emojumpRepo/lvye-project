<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.iocoder.yudao.module.psychology.dal.mysql.assessment.AssessmentUserTaskMapper">

    <select id="selectListByTaskNo"
            resultType="cn.iocoder.yudao.module.psychology.controller.admin.assessment.vo.AssessmentTaskUserVO">
        select
        a.id,
        b.id as student_profile_id,
        a.task_no,
        b.name as name,
        c.name as grade_name,
        d.name as class_name,
        a.status,
        a.submit_time,
        a.risk_level
        from lvye_assessment_user_task a
        left join lvye_student_profile b on a.user_id = b.user_id
        left join system_dept c on b.grade_dept_id = c.id
        left join system_dept d on b.class_dept_id = d.id
        where a.task_no = #{taskNo} and a.deleted = 0
    </select>

    <select id="selectCountByTaskNo" resultType="java.lang.Long">
        select count(*) from lvye_assessment_user_task where task_no = #{taskNo} and deleted = 0
    </select>

    <select id="selectCountByTaskNoAndStatus" resultType="java.lang.Long">
        select count(*) from lvye_assessment_user_task where task_no = #{taskNo} and status = #{status} and deleted = 0
    </select>

    <select id="selectStudentAssessmentTaskList"
            resultType="cn.iocoder.yudao.module.psychology.controller.admin.profile.vo.StudentAssessmentTaskHisVO">
        select
        b.id as task_id,
        a.task_no,
        b.task_name,
        b.target_audience,
        b.status,
        b.startline,
        b.deadline
        from lvye_assessment_user_task a
        left join lvye_assessment_task b on a.task_no  = b.task_no and b.deleted = 0
        left join lvye_student_profile c on c.user_id  = a.user_id
        where c.id = #{studentProfileId} and a.deleted = 0
    </select>

    <select id="selectStudentAssessmentTaskDetail"
            resultType="cn.iocoder.yudao.module.psychology.controller.admin.profile.vo.StudentAssessmentTaskDetailVO">
        select
        b.id as task_id,
        a.task_no,
        b.task_name,
        b.target_audience,
        b.status,
        b.startline,
        b.deadline
        from lvye_assessment_user_task a
        left join lvye_assessment_task b on a.task_no  = b.task_no and b.deleted = 0
        left join lvye_student_profile c on c.user_id  = a.user_id
        where c.id = #{studentProfileId} and a.task_no = #{taskNo} and a.deleted = 0
    </select>

    <!-- 统计：按年级/班级聚合，未知用 -1 表示 -->
    <select id="selectAggregationByDept"
            resultType="cn.iocoder.yudao.module.psychology.dal.dataobject.assessment.AssessmentDeptAggregationRow">
        select
            COALESCE(b.grade_dept_id, -1) as grade_dept_id,
            COALESCE(b.class_dept_id, -1) as class_dept_id,
            count(*) as total_cnt,
            sum(case when a.status = 2 then 1 else 0 end) as completed_cnt
        from lvye_assessment_user_task a
        left join lvye_student_profile b on a.user_id = b.user_id
        where a.task_no = #{taskNo} and a.deleted = 0
        group by COALESCE(b.grade_dept_id, -1), COALESCE(b.class_dept_id, -1)
    </select>



    <select id="selectQuestionnaireUserListByTaskNoAndQuestionnaire"
            resultType="cn.iocoder.yudao.module.psychology.controller.admin.assessment.vo.QuestionnaireUserVO">
        select
        s.id as student_profile_id,
        s.student_no,
        a.task_no,s.name,
        c.name as grade_name,
        d.name as class_name,
        if(r.id is null ,0,1) as status,
        r.completed_time as finish_time,
        r.risk_level as risk_level,
        r.score as score
        from lvye_assessment_user_task a
        left join lvye_student_profile s on s.user_id  = a.user_id
        left join system_dept c ON s.grade_dept_id = c.id
        left join system_dept d ON s.class_dept_id = d.id
        left join lvye_questionnaire_result r on r.assessment_task_no = a.task_no and r.questionnaire_id = #{pageReqVO.questionnaireId} and r.user_id = a.user_id
        <where>
            a.deleted = 0
            AND a.task_no = #{pageReqVO.taskNo}
            AND EXISTS (
                SELECT 1 FROM lvye_assessment_task_questionnaire b 
                WHERE b.task_no = a.task_no 
                AND b.questionnaire_id = #{pageReqVO.questionnaireId}
                AND b.deleted = 0
            )
            <if test="pageReqVO.studentNo != null and pageReqVO.studentNo !=''">
                AND s.student_no LIKE CONCAT('%',#{pageReqVO.studentNo},'%')
            </if>
            <if test="pageReqVO.name != null and pageReqVO.name !=''">
                AND s.name LIKE CONCAT('%',#{pageReqVO.name},'%')
            </if>
            <if test="pageReqVO.status != null">
                AND if(r.id is null ,0,1) = #{pageReqVO.status}
            </if>
            <if test="pageReqVO.riskLevel != null">
                AND r.risk_level = #{pageReqVO.riskLevel}
            </if>
            <if test="pageReqVO.classId != null and pageReqVO.classId.length > 0">
                <choose>
                    <when test="pageReqVO.classId.length == 1">
                        AND s.grade_dept_id = #{pageReqVO.classId[0]}
                    </when>
                    <when test="pageReqVO.classId.length == 2">
                        AND s.grade_dept_id = #{pageReqVO.classId[0]}
                        AND s.class_dept_id = #{pageReqVO.classId[1]}
                    </when>
                </choose>
            </if>
        </where>
    </select>

</mapper>