# 心理测评模块结构调整说明

## 调整背景

基于最新的会议讨论内容，对心理测评模块的基础结构进行了调整，以更好地支持新的业务需求。

## 主要调整内容

### 1. 新增枚举类

#### 用户角色枚举 (UserRoleEnum)
- **系统管理员** (system_admin)：拥有最高权限，可查看所有数据
- **年级管理员** (grade_manager)：可查看其所管辖年级的全部师生数据
- **班主任** (class_teacher)：可查看自己所带班级的完整学生数据
- **心理老师** (psychology_teacher)：权限与其被分配管理的班级挂钩，是系统的主要使用者
- **任课老师** (subject_teacher)：默认几乎无数据查看权限，主要功能是使用快速上报

#### 测评任务状态枚举 (AssessmentTaskStatusEnum)
- 未开始 (0)
- 进行中 (1)
- 已完成 (2)
- 已关闭 (3)

#### 参与者完成状态枚举 (ParticipantCompletionStatusEnum)
- 未开始 (0)
- 进行中 (1)
- 已完成 (2)

#### 时间线事件类型枚举 (TimelineEventTypeEnum)
- 档案创建 (1)
- 测评完成 (2)
- 咨询记录 (3)
- 危机干预 (4)
- 状态变更 (5)
- 家庭情况变更 (6)
- 毕业处理 (7)
- 快速上报 (8)

### 2. 新增业务包结构

#### 组织架构管理 (organization)
- 支持学校 → 学部 → 年级 → 班级的树状结构管理
- 班级作为部门的子类型进行管理
- 支持管理员对架构进行增、删、改、排序和设置负责人

#### 学生档案时间线 (timeline)
- 建立综合时间线，记录所有关键业务事件
- 时间线日志不可删除，确保数据完整性
- 支持测评历史、干预记录、家庭情况变更等事件记录

#### 快速上报 (quickreport)
- 任课老师专用的快速上报功能
- 支持快速上报学生异常情况
- 与时间线系统集成，自动记录上报事件

### 3. 错误码扩展

新增了以下错误码类别：
- 家长信息相关错误码
- 任务编号相关错误码
- 固定问卷相关错误码
- 权限相关错误码
- 组织架构相关错误码

### 4. 字典类型扩展

新增了以下字典类型：
- 部门类型 (dept_type)
- 用户角色类型 (user_role_type)
- 毕业状态 (graduation_status)
- 时间线事件类型 (timeline_event_type)

### 5. 包结构细化

#### 控制器层 (controller)
```
controller/
├── admin/
│   ├── organization/      # 组织架构管理控制器
│   ├── timeline/          # 时间线控制器
│   └── quickreport/       # 快速上报控制器
└── app/                   # 学生家长端控制器
```

#### 服务层 (service)
```
service/
├── assessment/            # 测评服务
├── profile/              # 档案服务
├── consultation/         # 咨询服务
├── notification/         # 通知服务
├── organization/         # 组织架构服务
├── timeline/             # 时间线服务
└── quickreport/          # 快速上报服务
```

#### 数据访问层 (dal)
```
dal/
├── dataobject/
│   ├── assessment/       # 测评相关DO
│   ├── profile/          # 档案相关DO
│   ├── timeline/         # 时间线相关DO
│   └── quickreport/      # 快速上报相关DO
└── mysql/
    ├── assessment/       # 测评相关Mapper
    ├── profile/          # 档案相关Mapper
    ├── timeline/         # 时间线相关Mapper
    └── quickreport/      # 快速上报相关Mapper
```

#### 对象转换层 (convert)
```
convert/
├── assessment/           # 测评相关转换器
├── profile/              # 档案相关转换器
└── timeline/             # 时间线相关转换器
```

## 核心业务需求支持

### 1. 登录与权限
- 支持统一默认密码设置
- 强制首次登录修改密码机制
- 细化的角色权限体系

### 2. 测评管理
- 任务ID/编号系统
- 固定问卷支持（第一期写死）
- 进度跟踪功能
- 双套问卷支持

### 3. 学生管理
- 家长信息绑定学生档案
- 批量导入导出功能
- 年级毕业功能
- 学生筛选功能

### 4. 权限管理
- 组织架构管理
- 班级即部门的映射关系
- 细化的角色权限划分

### 5. 档案时间线
- 综合时间线记录
- 不可删除的日志系统
- 关键业务事件追踪

## 下一步开发计划

1. **数据库表结构设计**：基于新的业务需求设计完整的数据库表结构
2. **核心业务逻辑实现**：实现测评管理、档案管理、时间线等核心功能
3. **API接口开发**：开发管理端和学生家长端的API接口
4. **权限系统集成**：与现有权限系统集成，实现细化的角色权限控制
5. **前端页面开发**：开发对应的前端管理页面
6. **测试与部署**：完成单元测试和集成测试

## 技术要点

- 复用现有的部门管理体系，将班级作为部门子类型
- 时间线系统采用不可删除设计，确保数据完整性
- 固定问卷采用硬编码方式，第一期不支持后台编辑
- 权限系统与现有系统无缝集成
- 支持多租户架构

## 最新变更记录

### 2025-01-22
- **移除数据迁移服务模块**：删除了 `service/migration` 包及相关的 `DataMigrationService` 接口和实现类
- **清理相关错误码**：移除了数据迁移相关的错误码定义（1-003-014-000 段）
- **原因**：该模块是专门用于从 emojump 系统迁移数据的临时工具，无外部依赖，属于一次性使用功能，现已完成使命