#!/usr/bin/env node

/**
 * README - å¿ƒä¹‹æ—…é¡¹ç›®å‘å¸ƒç³»ç»Ÿä½¿ç”¨æŒ‡å—
 * 
 * æœ¬é¡¹ç›®æä¾›äº†å®Œæ•´çš„è‡ªåŠ¨åŒ–å‘å¸ƒè§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æ„å»ºã€éƒ¨ç½²ã€ç‰ˆæœ¬ç®¡ç†å’Œé€šçŸ¥ã€‚
 */

# å¿ƒä¹‹æ—…é¡¹ç›®å‘å¸ƒç³»ç»Ÿ

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§

- âœ… **ä¸€é”®å‘å¸ƒ**ï¼šè‡ªåŠ¨å®Œæˆæ„å»ºã€éƒ¨ç½²ã€é€šçŸ¥å…¨æµç¨‹
- âœ… **ç‰ˆæœ¬ç®¡ç†**ï¼šè‡ªåŠ¨ç®¡ç†ç‰ˆæœ¬å·ï¼Œæ”¯æŒè¯­ä¹‰åŒ–ç‰ˆæœ¬
- âœ… **AI æ—¥å¿—ç”Ÿæˆ**ï¼šé€šè¿‡ Dify AI ç”Ÿæˆè¿è¥å‹å¥½çš„æ›´æ–°æ—¥å¿—
- âœ… **é£ä¹¦é€šçŸ¥**ï¼šå‘å¸ƒå®Œæˆè‡ªåŠ¨å‘é€é£ä¹¦ç¾¤é€šçŸ¥
- âœ… **çµæ´»é…ç½®**ï¼šæ”¯æŒé€‰æ‹©æ€§å‘å¸ƒå‰ç«¯/åç«¯
- âœ… **å¤‡ä»½æœºåˆ¶**ï¼šè‡ªåŠ¨å¤‡ä»½ï¼Œæ”¯æŒå¿«é€Ÿå›æ»š
- âœ… **æœ¬åœ°æ„å»º**ï¼šä¿æŒæœ¬åœ°æ§åˆ¶ï¼Œä¾¿äºè°ƒè¯•

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
npm install
```

### é…ç½®ç¯å¢ƒï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ä¿®æ”¹é»˜è®¤é…ç½®ï¼Œå¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
# Windows
set SSH_PASSWORD=your_password
set DIFY_API_KEY=your_api_key
set FEISHU_WEBHOOK_URL=your_webhook_url

# Linux/Mac
export SSH_PASSWORD=your_password
export DIFY_API_KEY=your_api_key
export FEISHU_WEBHOOK_URL=your_webhook_url
```

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### 1. å®Œæ•´å‘å¸ƒï¼ˆæ¨èï¼‰

äº¤äº’å¼å‘å¸ƒï¼Œæ‰‹åŠ¨è¾“å…¥ç‰ˆæœ¬å·ï¼š

```bash
npm run release
```

ç³»ç»Ÿä¼šæç¤ºï¼š
- è¾“å…¥ç‰ˆæœ¬å·ï¼ˆå¦‚ 1.2.0ï¼‰
- é€‰æ‹©å‘å¸ƒå†…å®¹ï¼ˆå‰ç«¯/åç«¯/å…¨éƒ¨ï¼‰
- ç¡®è®¤å‘å¸ƒ

### 2. å¿«é€Ÿå‘å¸ƒ

è‡ªåŠ¨è®¡ç®—ç‰ˆæœ¬å·å¹¶å‘å¸ƒï¼š

```bash
# å‘å¸ƒè¡¥ä¸ç‰ˆæœ¬ (1.0.0 -> 1.0.1)
npm run release:patch

# å‘å¸ƒæ¬¡è¦ç‰ˆæœ¬ (1.0.0 -> 1.1.0)
npm run release:minor

# å‘å¸ƒä¸»è¦ç‰ˆæœ¬ (1.0.0 -> 2.0.0)
npm run release:major

# è‡ªåŠ¨å‘å¸ƒï¼ˆç›¸å½“äº patchï¼‰
npm run release:auto
```

### 3. ä»…æ„å»º

åªæ„å»ºä¸éƒ¨ç½²ï¼š

```bash
# æ„å»ºåç«¯
npm run build:backend

# æ„å»ºå‰ç«¯
npm run build:frontend

# æ„å»ºå…¨éƒ¨
npm run build:all
```

### 4. ä»…éƒ¨ç½²

ä½¿ç”¨å·²æ„å»ºçš„æ–‡ä»¶è¿›è¡Œéƒ¨ç½²ï¼š

```bash
# éƒ¨ç½²åç«¯
npm run deploy:backend

# éƒ¨ç½²å‰ç«¯
npm run deploy:frontend

# éƒ¨ç½²å…¨éƒ¨
npm run deploy:all
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
mindtrip-project/
â”œâ”€â”€ script/
â”‚   â”œâ”€â”€ release.mjs          # ä¸»å‘å¸ƒè„šæœ¬
â”‚   â”œâ”€â”€ quick-release.mjs    # å¿«é€Ÿå‘å¸ƒè„šæœ¬
â”‚   â””â”€â”€ config/
â”‚       â””â”€â”€ deploy.config.js # éƒ¨ç½²é…ç½®æ–‡ä»¶
â”œâ”€â”€ script/windows/
â”‚   â”œâ”€â”€ deploy-backend.mjs   # åç«¯éƒ¨ç½²è„šæœ¬
â”‚   â””â”€â”€ deploy-frontend.mjs  # å‰ç«¯éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ releases.log             # å‘å¸ƒå†å²è®°å½•
â””â”€â”€ package.json            # é¡¹ç›®é…ç½®å’Œè„šæœ¬
```

## âš™ï¸ é…ç½®è¯´æ˜

### éƒ¨ç½²é…ç½® (script/config/deploy.config.js)

ä¸»è¦é…ç½®é¡¹ï¼š

- **server**: æœåŠ¡å™¨è¿æ¥ä¿¡æ¯
- **api.dify**: Dify AI é…ç½®
- **api.feishu**: é£ä¹¦é€šçŸ¥é…ç½®
- **backup**: å¤‡ä»½è®¾ç½®
- **oss**: OSS é…ç½®ï¼ˆé¢„ç•™ï¼‰

### ç‰ˆæœ¬å·è§„åˆ™

- **ä¸»ç‰ˆæœ¬å· (Major)**: é‡å¤§æ›´æ–°ï¼Œä¸å…¼å®¹çš„ API ä¿®æ”¹
- **æ¬¡ç‰ˆæœ¬å· (Minor)**: åŠŸèƒ½æ€§æ–°å¢ï¼Œå‘ä¸‹å…¼å®¹
- **ä¿®è®¢å· (Patch)**: ä¿®å¤é—®é¢˜ï¼Œå‘ä¸‹å…¼å®¹

## ğŸ”„ å‘å¸ƒæµç¨‹

1. **ç‰ˆæœ¬æ£€æŸ¥**ï¼šç¡®è®¤ç‰ˆæœ¬å·å’Œå‘å¸ƒå†…å®¹
2. **æ„å»ºé¡¹ç›®**ï¼š
   - åç«¯ï¼šMaven æ‰“åŒ…ç”Ÿæˆ JAR
   - å‰ç«¯ï¼špnpm build ç”Ÿæˆ dist.zip
3. **éƒ¨ç½²åˆ°æœåŠ¡å™¨**ï¼š
   - ä¸Šä¼ æ„å»ºäº§ç‰©
   - å¤‡ä»½æ—§ç‰ˆæœ¬
   - æ›´æ–°æœåŠ¡
4. **ç”Ÿæˆæ—¥å¿—**ï¼š
   - è·å– Git æäº¤è®°å½•
   - è°ƒç”¨ Dify AI ç”Ÿæˆè¿è¥æ—¥å¿—
5. **å‘é€é€šçŸ¥**ï¼š
   - å‘é€é£ä¹¦ç¾¤é€šçŸ¥
   - è®°å½•å‘å¸ƒå†å²

## ğŸ“Š å‘å¸ƒè®°å½•

å‘å¸ƒè®°å½•ä¿å­˜åœ¨ `releases.log` æ–‡ä»¶ä¸­ï¼Œæ ¼å¼ï¼š

```json
{"version":"v1.0.0","content":"å‰ç«¯+åç«¯","timestamp":"2025-01-22T10:00:00.000Z","deployer":"user","server":"42.194.163.176"}
```

## ğŸ”§ æ•…éšœå¤„ç†

### æ„å»ºå¤±è´¥

1. æ£€æŸ¥ Maven å’Œ Node.js ç¯å¢ƒ
2. ç¡®ä¿ä¾èµ–å·²å®‰è£…ï¼š`npm install` å’Œ `pnpm install`
3. æŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯

### éƒ¨ç½²å¤±è´¥

1. æ£€æŸ¥æœåŠ¡å™¨è¿æ¥ï¼š`ping 42.194.163.176`
2. éªŒè¯ SSH å¯†ç æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤æœåŠ¡å™¨ç£ç›˜ç©ºé—´å……è¶³

### é€šçŸ¥å¤±è´¥

1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. éªŒè¯ API å¯†é’¥å’Œ Webhook URL
3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—

## ğŸ”™ å›æ»šæ“ä½œ

å¦‚æœå‘å¸ƒåå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# SSH ç™»å½•æœåŠ¡å™¨
ssh root@42.194.163.176

# åç«¯å›æ»š
cd /root/mindfront/work/project/mindtrip_server
cp backup/yudao-server.jar.æœ€æ–°æ—¶é—´æˆ³.bak yudao-server.jar
docker-compose restart

# å‰ç«¯å›æ»š
cd /root/mindfront/work/project/mindtrip_apps/admin_backup
cp -r backup_æœ€æ–°æ—¶é—´æˆ³/* ../admin/
```

## ğŸ¯ æœ€ä½³å®è·µ

1. **å‘å¸ƒå‰æ£€æŸ¥**ï¼š
   - ç¡®ä¿ä»£ç å·²æäº¤
   - æœ¬åœ°æµ‹è¯•é€šè¿‡
   - æŸ¥çœ‹æ˜¯å¦æœ‰æœªå®Œæˆçš„åŠŸèƒ½

2. **ç‰ˆæœ¬å·ç®¡ç†**ï¼š
   - Bug ä¿®å¤ä½¿ç”¨ patch
   - æ–°åŠŸèƒ½ä½¿ç”¨ minor
   - æ¶æ„è°ƒæ•´ä½¿ç”¨ major

3. **å‘å¸ƒæ—¶æœº**ï¼š
   - é¿å…åœ¨é«˜å³°æœŸå‘å¸ƒ
   - é¢„ç•™å›æ»šæ—¶é—´
   - é€šçŸ¥ç›¸å…³äººå‘˜

## ğŸ“® æŠ€æœ¯æ”¯æŒ

- æœåŠ¡å™¨ï¼š42.194.163.176
- Dify APIï¼šhttp://154.9.255.162/v1
- é£ä¹¦ç¾¤ï¼šé€šè¿‡ Webhook æ¥æ”¶é€šçŸ¥

## ğŸ” å®‰å…¨æç¤º

1. ä¸è¦å°†å¯†ç æäº¤åˆ° Git
2. ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®
3. å®šæœŸæ›´æ–°ä¾èµ–åŒ…
4. ä¿æŠ¤å¥½ API å¯†é’¥

---

*æœ€åæ›´æ–°ï¼š2025-01-22*