# CNB äº‘åŸç”Ÿæ„å»ºé…ç½® - èŠ‹é“ RuoYi-Vue-Pro åç«¯é¡¹ç›®
#
# é¡¹ç›®ç»“æ„ï¼šSpring Boot + Maven å¤šæ¨¡å—é¡¹ç›®
# ä¸»è¦æ¨¡å—ï¼š
#   - yudao-server: ä¸»åº”ç”¨æœåŠ¡å™¨
#   - yudao-module-*: å„ä¸šåŠ¡æ¨¡å—
#   - yudao-framework*: æ¡†æ¶æ‰©å±•
#
# åˆ†æ”¯ç­–ç•¥ï¼š
#   - develop-web: æµ‹è¯•ç¯å¢ƒæ„å»ºå’Œéƒ¨ç½²
#
# å‚è€ƒ: https://cnb.cool/examples/ecosystem/springboot-maven-ssh
# ç¼“å­˜ä¼˜åŒ–æ–‡æ¡£: https://docs.cnb.cool/zh/build/pipeline-cache.html

# ==================== æµ‹è¯•ç¯å¢ƒ - åç«¯æœåŠ¡ (SSH éƒ¨ç½²) ====================
develop-web:
  push:
    - name: æ„å»º Spring Boot åº”ç”¨
      services:
        - docker
      env:
        JAVA_VERSION: 17
      # å¯¼å…¥ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶ï¼ˆç”¨äº SSH éƒ¨ç½²ï¼‰
      imports:
        - https://cnb.cool/mindfront/psychology/deploy-credentials/-/blob/main/mindtrip-psychology-backend-envs.yml

      # ä½¿ç”¨ CNB å®˜æ–¹ç¼“å­˜æœºåˆ¶
      caches:
        - path: ~/.m2/repository

      stages:
        - name: è®¾ç½®æ„å»ºç¯å¢ƒ
          script: |
            apt-get update -qq
            apt-get install -y -qq openjdk-${JAVA_VERSION}-jdk maven

            export JAVA_HOME=/usr/lib/jvm/java-${JAVA_VERSION}-openjdk-amd64
            export PATH=$JAVA_HOME/bin:$PATH

            java -version
            mvn -version

        - name: Maven æ„å»º
          script: |
            export JAVA_HOME=/usr/lib/jvm/java-${JAVA_VERSION}-openjdk-amd64
            export PATH=$JAVA_HOME/bin:$PATH
            # ä»æ ¹ç›®å½•æ„å»ºæ•´ä¸ªé¡¹ç›®ï¼ˆå¹¶è¡Œæ„å»º + æ‰¹å¤„ç†æ¨¡å¼ + ç¦ç”¨ä¼ è¾“è¿›åº¦ï¼‰
            mvn clean install \
              -Dmaven.test.skip=true \
              -Dmaven.compile.fork=true \
              -T 1C \
              --batch-mode \
              --no-transfer-progress

        # SSH éƒ¨ç½²é˜¶æ®µ
        - name: SSH éƒ¨ç½²
          plugins:
            - name: ssh
              config:
                host: ${DEV_SSH_HOST}
                user: ${DEV_SSH_USERNAME}
                port: ${DEV_SSH_PORT:-22}
                privateKey: ${DEV_SSH_PRIVATE_KEY}
              script: |
                echo "ğŸš€ Deploying to remote server..."
                echo "ğŸ“¦ Project: RuoYi-Vue-Pro Backend"
                echo "ğŸ–¥ï¸ Server: ${DEV_SSH_HOST}"
                echo "â° Time: $(date '+%Y-%m-%d %H:%M:%S')"

                # è®¾ç½®ç›®æ ‡è·¯å¾„
                SERVER_PATH="/root/mindfront/work/project/mindtrip_server"
                TARGET_JAR="$SERVER_PATH/yudao-server.jar"

                # æŸ¥æ‰¾æ„å»ºçš„ JAR æ–‡ä»¶
                JAR_FILE=$(find . -name "yudao-server-*.jar" -type f | head -1)

                if [ -z "$JAR_FILE" ]; then
                  echo "âŒ Error: JAR file not found!"
                  exit 1
                fi

                echo "ğŸ“¤ Found JAR file: $(basename "$JAR_FILE")"

                # å¤‡ä»½å½“å‰ JAR æ–‡ä»¶
                echo "ğŸ’¾ Backing up current JAR file..."
                if [ -f "$TARGET_JAR" ]; then
                  cp "$TARGET_JAR" "$TARGET_JAR.backup.$(date +%Y%m%d_%H%M%S)"
                  echo "âœ… Backup created"
                else
                  echo "â„¹ï¸ No existing JAR file to backup"
                fi

                # ä¸Šä¼ æ–°çš„ JAR æ–‡ä»¶
                echo "ğŸ“¤ Uploading new JAR file..."
                cp "$JAR_FILE" "$TARGET_JAR"

                # éªŒè¯ä¸Šä¼ 
                echo "ğŸ” Verifying uploaded file..."
                ls -lh "$TARGET_JAR"

                # é‡å¯ Docker å®¹å™¨
                echo "ğŸ”„ Restarting Docker container..."
                docker restart mindtrip

                # ç­‰å¾…å®¹å™¨å¯åŠ¨
                echo "â³ Waiting for container to start..."
                sleep 15

                # æ£€æŸ¥å®¹å™¨çŠ¶æ€
                echo "ğŸ” Checking container status..."
                docker ps --filter "name=mindtrip" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

                # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘ 5 ä¸ªï¼‰
                echo "ğŸ§¹ Cleaning up old backups..."
                cd "$SERVER_PATH" && ls -t yudao-server.jar.backup.* 2>/dev/null | tail -n +6 | xargs -r rm -f

                echo ""
                echo "=========================================="
                echo "ğŸ‰ æµ‹è¯•ç¯å¢ƒåç«¯æœåŠ¡éƒ¨ç½²å®Œæˆ"
                echo "=========================================="
                echo "ğŸ“¦ é¡¹ç›®: RuoYi-Vue-Pro Backend"
                echo "ğŸ–¥ï¸ æœåŠ¡å™¨: ${DEV_SSH_HOST}"
                echo "ğŸ³ å®¹å™¨: mindtrip"
                echo "ğŸ“‚ è·¯å¾„: $TARGET_JAR"
                echo "â° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
                echo "=========================================="
                echo ""
                echo "ğŸ“‹ éƒ¨ç½²æ–¹å¼ï¼š"
                echo "  1. æ„å»º JAR æ–‡ä»¶"
                echo "  2. å¤‡ä»½å½“å‰ JAR æ–‡ä»¶"
                echo "  3. ç›´æ¥æ›¿æ¢ /root/mindfront/work/project/mindtrip_server/yudao-server.jar"
                echo "  4. é‡å¯ Docker å®¹å™¨: docker restart mindtrip"
                echo ""
                echo "ğŸ”§ åº”ç”¨ä¿¡æ¯ï¼š"
                echo "  åº”ç”¨ç±»å‹: Spring Boot Java åº”ç”¨"
                echo "  å®¹å™¨åç§°: mindtrip"
                echo "  é•œåƒ: bitnamilegacy/java:17"
                echo "  ç«¯å£: 48080"
                echo "  æŒ‚è½½ç›®å½•: /root/mindfront/work/project/mindtrip_server -> /app"
                echo "  é…ç½®æ–‡ä»¶: application-dev.yaml"
                echo ""
                echo "ğŸ“‹ ç®¡ç†å‘½ä»¤ï¼š"
                echo "  æŸ¥çœ‹çŠ¶æ€: docker ps | grep mindtrip"
                echo "  æŸ¥çœ‹æ—¥å¿—: docker logs mindtrip"
                echo "  é‡å¯æœåŠ¡: docker restart mindtrip"
                echo "  æŸ¥çœ‹ JAR æ–‡ä»¶: ls -lh /root/mindfront/work/project/mindtrip_server/yudao-server.jar"
                echo "  æŸ¥çœ‹å¤‡ä»½: ls -lh /root/mindfront/work/project/mindtrip_server/yudao-server.jar.backup.*"
                echo "=========================================="

# ==================== ç”Ÿäº§ç¯å¢ƒè¯´æ˜ ====================
# æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²åœ¨ç‹¬ç«‹æœåŠ¡å™¨ä¸Šï¼Œä¸ä½¿ç”¨æ­¤ CI/CD é…ç½®
# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ­¥éª¤ï¼š
# 1. æ‰‹åŠ¨æ„å»ºï¼šmvn clean install -Dmaven.test.skip=true -Dspring.profiles.active=prod
# 2. æ‰‹åŠ¨ä¸Šä¼  JAR æ–‡ä»¶åˆ°ç”Ÿäº§æœåŠ¡å™¨
# 3. é‡å¯ç”Ÿäº§ç¯å¢ƒå®¹å™¨ï¼šdocker restart mindtrip-prod
#
# ç”Ÿäº§ç¯å¢ƒä¿¡æ¯ï¼š
# - æœåŠ¡å™¨ï¼šç‹¬ç«‹çš„ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨
# - å®¹å™¨åç§°ï¼šmindtrip-prod
# - é•œåƒï¼šbitnamilegacy/java:17
# - ç«¯å£ï¼š48080
# - é…ç½®æ–‡ä»¶ï¼šapplication-prod.yaml