# CNB äº‘åŸç”Ÿæ„å»ºé…ç½® - èŠ‹é“ RuoYi-Vue-Pro åç«¯é¡¹ç›®
#
# é¡¹ç›®ç»“æ„ï¼šSpring Boot + Maven å¤šæ¨¡å—é¡¹ç›®
# ä¸»è¦æ¨¡å—ï¼š
#   - yudao-server: ä¸»åº”ç”¨æœåŠ¡å™¨
#   - yudao-module-*: å„ä¸šåŠ¡æ¨¡å—
#   - yudao-framework*: æ¡†æ¶æ‰©å±•
#
# åˆ†æ”¯ç­–ç•¥ï¼š
#   - develop-web: æµ‹è¯•ç¯å¢ƒæ„å»ºå’Œéƒ¨ç½²
#
# å‚è€ƒ: https://cnb.cool/examples/ecosystem/springboot-maven-ssh
# ç¼“å­˜ä¼˜åŒ–æ–‡æ¡£: https://docs.cnb.cool/zh/build/pipeline-cache.html

# ==================== æµ‹è¯•ç¯å¢ƒ - åç«¯æœåŠ¡ (SSH éƒ¨ç½²) ====================
develop-web:
  push:
    - name: æ„å»º Spring Boot åº”ç”¨
      docker:
        # ä½¿ç”¨å®˜æ–¹ Maven é•œåƒ
        image: maven:3.9-openjdk-17
        # å£°æ˜æ„å»ºç¼“å­˜
        volumes:
          - /root/.m2:copy-on-write

      # å¯¼å…¥ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶ï¼ˆç”¨äº SSH éƒ¨ç½²ï¼‰
      imports:
        - https://cnb.cool/mindfront/psychology/deploy-credentials/-/blob/main/mindtrip-psychology-backend-envs.yml

      stages:
        - name: Maven æ„å»º
          script: |
            # ä»æ ¹ç›®å½•æ„å»ºæ•´ä¸ªé¡¹ç›®ï¼ˆå¹¶è¡Œæ„å»º + æ‰¹å¤„ç†æ¨¡å¼ + ç¦ç”¨ä¼ è¾“è¿›åº¦ï¼‰
            mvn clean install \
              -Dmaven.test.skip=true \
              -Dmaven.compile.fork=true \
              -T 1C \
              --batch-mode \
              --no-transfer-progress

        # ä½¿ç”¨ rsync å¤åˆ¶æ–‡ä»¶
        - name: ä½¿ç”¨ rsync ä¸Šä¼  JAR æ–‡ä»¶
          image: tencentcom/rsync
          settings:
            hosts:
              - ${DEV_SSH_HOST}
            user: ${DEV_SSH_USERNAME}
            key: ${DEV_SSH_PRIVATE_KEY}
            port: ${DEV_SSH_PORT:-22}
            target: /root/mindfront/work/project/mindtrip_server/yudao-server.jar
            source: ./yudao-server/yudao-server/target/yudao-server-*.jar

        # é€šè¿‡ SSH æ‰§è¡Œå‘½ä»¤
        - name: é€šè¿‡ SSH é‡å¯å®¹å™¨
          image: tencentcom/ssh
          settings:
            host:
              - ${DEV_SSH_HOST}
            username: ${DEV_SSH_USERNAME}
            key: ${DEV_SSH_PRIVATE_KEY}
            port: ${DEV_SSH_PORT:-22}
            command_timeout: 5m
            script: |
              echo "ğŸš€ éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨..."
              echo "ğŸ“¦ é¡¹ç›®: RuoYi-Vue-Pro Backend"
              echo "ğŸ–¥ï¸ æœåŠ¡å™¨: ${DEV_SSH_HOST}"
              echo "â° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"

              # è®¾ç½®ç›®æ ‡è·¯å¾„
              SERVER_PATH="/root/mindfront/work/project/mindtrip_server"
              TARGET_JAR="$SERVER_PATH/yudao-server.jar"

              # å¤‡ä»½å½“å‰ JAR æ–‡ä»¶
              echo "ğŸ’¾ å¤‡ä»½å½“å‰ JAR æ–‡ä»¶..."
              if [ -f "$TARGET_JAR" ]; then
                cp "$TARGET_JAR" "$TARGET_JAR.backup.$(date +%Y%m%d_%H%M%S)"
                echo "âœ… å¤‡ä»½åˆ›å»ºæˆåŠŸ"
              else
                echo "â„¹ï¸ æ²¡æœ‰ç°æœ‰ JAR æ–‡ä»¶éœ€è¦å¤‡ä»½"
              fi

              # rsync ä¼šè‡ªåŠ¨ä¸Šä¼ ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦é‡å‘½åæ–‡ä»¶
              echo "ğŸ”„ é‡å‘½åä¸Šä¼ çš„æ–‡ä»¶..."
              find ./yudao-server/yudao-server/target -name "yudao-server-*.jar" -exec basename {} \; | head -1 | while read jar_name; do
                if [ -f "./yudao-server/yudao-server/target/$jar_name" ]; then
                  mv "./yudao-server/yudao-server/target/$jar_name" "$TARGET_JAR"
                  echo "âœ… æ–‡ä»¶é‡å‘½åå®Œæˆ: $jar_name -> yudao-server.jar"
                fi
              done

              # éªŒè¯æ–‡ä»¶
              echo "ğŸ” éªŒè¯ä¸Šä¼ çš„æ–‡ä»¶..."
              if [ -f "$TARGET_JAR" ]; then
                ls -lh "$TARGET_JAR"
                echo "âœ… æ–‡ä»¶éªŒè¯æˆåŠŸ"
              else
                echo "âŒ æ–‡ä»¶éªŒè¯å¤±è´¥"
                exit 1
              fi

              # é‡å¯ Docker å®¹å™¨
              echo "ğŸ”„ é‡å¯ Docker å®¹å™¨..."
              docker restart mindtrip

              # ç­‰å¾…å®¹å™¨å¯åŠ¨
              echo "â³ ç­‰å¾…å®¹å™¨å¯åŠ¨..."
              sleep 15

              # æ£€æŸ¥å®¹å™¨çŠ¶æ€
              echo "ğŸ” æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
              docker ps --filter "name=mindtrip" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

              # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘ 5 ä¸ªï¼‰
              echo "ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶..."
              cd "$SERVER_PATH" && ls -t yudao-server.jar.backup.* 2>/dev/null | tail -n +6 | xargs -r rm -f

              echo ""
              echo "=========================================="
              echo "ğŸ‰ æµ‹è¯•ç¯å¢ƒåç«¯æœåŠ¡éƒ¨ç½²å®Œæˆ"
              echo "=========================================="
              echo "ğŸ“¦ é¡¹ç›®: RuoYi-Vue-Pro Backend"
              echo "ğŸ–¥ï¸ æœåŠ¡å™¨: ${DEV_SSH_HOST}"
              echo "ğŸ³ å®¹å™¨: mindtrip"
              echo "ğŸ“‚ è·¯å¾„: $TARGET_JAR"
              echo "â° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
              echo "=========================================="
              echo ""
              echo "ğŸ“‹ éƒ¨ç½²æ–¹å¼ï¼š"
              echo "  1. æ„å»º JAR æ–‡ä»¶"
              echo "  2. ä½¿ç”¨ rsync ä¸Šä¼  JAR æ–‡ä»¶"
              echo "  3. å¤‡ä»½å½“å‰ JAR æ–‡ä»¶"
              echo "  4. é‡å‘½åå¹¶æ›¿æ¢ JAR æ–‡ä»¶"
              echo "  5. é‡å¯ Docker å®¹å™¨: docker restart mindtrip"
              echo ""
              echo "ğŸ”§ åº”ç”¨ä¿¡æ¯ï¼š"
              echo "  åº”ç”¨ç±»å‹: Spring Boot Java åº”ç”¨"
              echo "  å®¹å™¨åç§°: mindtrip"
              echo "  é•œåƒ: bitnamilegacy/java:17"
              echo "  ç«¯å£: 48080"
              echo "  æŒ‚è½½ç›®å½•: /root/mindfront/work/project/mindtrip_server -> /app"
              echo "  é…ç½®æ–‡ä»¶: application-dev.yaml"
              echo ""
              echo "ğŸ“‹ ç®¡ç†å‘½ä»¤ï¼š"
              echo "  æŸ¥çœ‹çŠ¶æ€: docker ps | grep mindtrip"
              echo "  æŸ¥çœ‹æ—¥å¿—: docker logs mindtrip"
              echo "  é‡å¯æœåŠ¡: docker restart mindtrip"
              echo "  æŸ¥çœ‹ JAR æ–‡ä»¶: ls -lh /root/mindfront/work/project/mindtrip_server/yudao-server.jar"
              echo "  æŸ¥çœ‹å¤‡ä»½: ls -lh /root/mindfront/work/project/mindtrip_server/yudao-server.jar.backup.*"
              echo "=========================================="

# ==================== ç”Ÿäº§ç¯å¢ƒè¯´æ˜ ====================
# æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²åœ¨ç‹¬ç«‹æœåŠ¡å™¨ä¸Šï¼Œä¸ä½¿ç”¨æ­¤ CI/CD é…ç½®
# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ­¥éª¤ï¼š
# 1. æ‰‹åŠ¨æ„å»ºï¼šmvn clean install -Dmaven.test.skip=true -Dspring.profiles.active=prod
# 2. æ‰‹åŠ¨ä¸Šä¼  JAR æ–‡ä»¶åˆ°ç”Ÿäº§æœåŠ¡å™¨
# 3. é‡å¯ç”Ÿäº§ç¯å¢ƒå®¹å™¨ï¼šdocker restart mindtrip-prod
#
# ç”Ÿäº§ç¯å¢ƒä¿¡æ¯ï¼š
# - æœåŠ¡å™¨ï¼šç‹¬ç«‹çš„ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨
# - å®¹å™¨åç§°ï¼šmindtrip-prod
# - é•œåƒï¼šbitnamilegacy/java:17
# - ç«¯å£ï¼š48080
# - é…ç½®æ–‡ä»¶ï¼šapplication-prod.yaml