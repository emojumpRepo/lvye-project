# CNB äº‘åŸç”Ÿæ„å»ºé…ç½® - èŠ‹é“ RuoYi-Vue-Pro åç«¯é¡¹ç›®
#
# é¡¹ç›®ç»“æ„ï¼šSpring Boot + Maven å¤šæ¨¡å—é¡¹ç›®
# ä¸»è¦æ¨¡å—ï¼š
#   - yudao-server: ä¸»åº”ç”¨æœåŠ¡å™¨
#   - yudao-module-*: å„ä¸šåŠ¡æ¨¡å—
#   - yudao-framework*: æ¡†æ¶æ‰©å±•
#
# åˆ†æ”¯ç­–ç•¥ï¼š
#   - main: ç”Ÿäº§ç¯å¢ƒæ„å»ºå’Œéƒ¨ç½²
#   - develop-web: æµ‹è¯•ç¯å¢ƒæ„å»ºå’Œéƒ¨ç½²
#
# éƒ¨ç½²æ–¹å¼ï¼š1Panel Java è¿è¡Œç¯å¢ƒ
# æ–‡æ¡£ï¼šhttps://docs.cnb.cool

# ==================== æµ‹è¯•ç¯å¢ƒ - åç«¯æœåŠ¡ (1Panel éƒ¨ç½²) ====================
develop-web:
  push:
    - docker:
        image: maven:3.9-openjdk-17
      # å¯¼å…¥ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶ï¼ˆç”¨äº 1Panel API è°ƒç”¨ï¼‰
      imports:
        - https://cnb.cool/mindfront/psychology/deploy-credentials/-/blob/main/mindtrip-psychology-backend-envs.yml

      # ä½¿ç”¨ CNB å®˜æ–¹ç¼“å­˜æœºåˆ¶
      caches:
        - path: ~/.m2/repository

      stages:
        # ===== Stage 1: ç¯å¢ƒå‡†å¤‡å’ŒéªŒè¯ =====
        - name: ç¯å¢ƒå‡†å¤‡
          script: |
            echo "ğŸ”§ Setting up 1Panel build environment..."

            # éªŒè¯ Java ç¯å¢ƒ
            java -version
            echo "âœ… Java version verified"

            # éªŒè¯ Maven ç¯å¢ƒ
            mvn -version
            echo "âœ… Maven version verified"

            # å®‰è£…å¿…è¦å·¥å…·ï¼ˆç”¨äº 1Panel API è°ƒç”¨ï¼‰
            apt-get update -qq
            apt-get install -y -qq curl jq

            # æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
            echo "ğŸ“‹ Project Information:"
            echo "  Working Directory: $(pwd)"
            echo "  Java Version: $(java -version 2>&1 | head -1)"
            echo "  Maven Version: $(mvn -version 2>&1 | head -1)"
            echo "  1Panel API: $ONEPANEL_URL"

        # ===== Stage 2: Maven æ„å»º =====
        - name: æ„å»º Spring Boot åº”ç”¨
          script: |
            echo "ğŸ—ï¸ Building Spring Boot application for 1Panel deployment..."

            # æ¸…ç†å¹¶æ„å»ºé¡¹ç›®ï¼ˆå¹¶è¡Œæ„å»º + æ‰¹å¤„ç†æ¨¡å¼ + ç¦ç”¨ä¼ è¾“è¿›åº¦ï¼‰
            mvn clean install \
              -Dmaven.test.skip=true \
              -Dmaven.compile.fork=true \
              -T 1C \
              --batch-mode \
              --no-transfer-progress

            echo "âœ… Maven build completed"

        # ===== Stage 3: éªŒè¯æ„å»ºäº§ç‰© =====
        - name: éªŒè¯æ„å»ºäº§ç‰©
          script: |
            echo "ğŸ” Verifying build artifacts for 1Panel..."

            # æŸ¥æ‰¾ä¸»è¦çš„ JAR æ–‡ä»¶
            JAR_FILE=$(find . -name "yudao-server-*.jar" -type f | head -1)

            if [ -z "$JAR_FILE" ]; then
              echo "âŒ Error: JAR file not found!"
              echo "Looking for files matching pattern: yudao-server-*.jar"
              find . -name "*.jar" -type f | head -10
              exit 1
            fi

            echo "âœ… JAR file found: $JAR_FILE"

            # éªŒè¯ JAR æ–‡ä»¶
            if [ -f "$JAR_FILE" ]; then
              JAR_SIZE=$(stat -c%s "$JAR_FILE")
              JAR_SIZE_MB=$(echo "scale=2; $JAR_SIZE / 1024 / 1024" | bc)
              echo "  File size: ${JAR_SIZE_MB} MB"

              # æ£€æŸ¥ JAR æ–‡ä»¶ç»“æ„
              if jar tf "$JAR_FILE" | grep -q "BOOT-INF"; then
                echo "  âœ“ Valid Spring Boot JAR structure"
              else
                echo "  âš ï¸ Warning: Unexpected JAR structure"
              fi

              # ç”Ÿæˆæ–‡ä»¶ä¿¡æ¯ï¼ˆç”¨äº 1Panel ä¸Šä¼ ï¼‰
              JAR_NAME=$(basename "$JAR_FILE")
              JAR_CHECKSUM=$(sha256sum "$JAR_FILE" | cut -d' ' -f1)
              echo "  File name: $JAR_NAME"
              echo "  SHA256: $JAR_CHECKSUM"
            else
              echo "âŒ JAR file validation failed!"
              exit 1
            fi

        # ===== Stage 4: ä¸Šä¼  JAR æ–‡ä»¶åˆ°æœåŠ¡å™¨ =====
        - name: ä¸Šä¼  JAR æ–‡ä»¶åˆ°æœåŠ¡å™¨
          script: |
            echo "ğŸ“¤ Uploading JAR file to server..."

            # æŸ¥æ‰¾ JAR æ–‡ä»¶
            JAR_FILE=$(find . -name "yudao-server-*.jar" -type f | head -1)
            JAR_NAME=$(basename "$JAR_FILE")

            echo "ğŸ“¦ Uploading file: $JAR_NAME"

            # å®‰è£…éƒ¨ç½²å·¥å…·
            apt-get update -qq
            apt-get install -y -qq openssh-client rsync

            # é…ç½® SSH è¿æ¥
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            echo "$DEV_SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/id_ed25519"

            # ç›®æ ‡è·¯å¾„ï¼ˆå®¹å™¨æŒ‚è½½çš„ç›®å½•ï¼‰
            SERVER_PATH="/root/mindfront/work/project/mindtrip_server"
            TARGET_JAR="$SERVER_PATH/yudao-server.jar"

            # å¤‡ä»½å½“å‰ JAR æ–‡ä»¶
            echo "ğŸ’¾ Backing up current JAR file..."
            ssh $SSH_OPTS $DEV_SSH_USERNAME@$DEV_SSH_HOST "if [ -f '$TARGET_JAR' ]; then cp '$TARGET_JAR' '$TARGET_JAR.backup.$(date +%Y%m%d_%H%M%S)'; echo 'Backup created'; else echo 'No existing JAR file to backup'; fi"

            # ç›´æ¥ä¸Šä¼ æ–°çš„ JAR æ–‡ä»¶
            echo "ğŸ“¤ Uploading new JAR file to: $TARGET_JAR"
            rsync -avz --progress \
              -e "ssh $SSH_OPTS" \
              "$JAR_FILE" \
              $DEV_SSH_USERNAME@$DEV_SSH_HOST:"$TARGET_JAR"

            # éªŒè¯æ–‡ä»¶ä¸Šä¼ 
            echo "ğŸ” Verifying uploaded file..."
            FILE_INFO=$(ssh $SSH_OPTS $DEV_SSH_USERNAME@$DEV_SSH_HOST "ls -lh '$TARGET_JAR' 2>/dev/null || echo 'File not found'")
            echo "  File info: $FILE_INFO"

            echo "âœ… JAR file uploaded and replaced successfully"

        # ===== Stage 5: é‡å¯ Docker å®¹å™¨ =====
        - name: é‡å¯ Docker å®¹å™¨
          script: |
            echo "ğŸ”„ Restarting Docker container..."

            # é€šè¿‡ SSH æ‰§è¡Œ Docker é‡å¯å‘½ä»¤
            echo "ğŸ“‹ Restarting mindtrip container..."
            RESTART_RESULT=$(ssh $SSH_OPTS $DEV_SSH_USERNAME@$DEV_SSH_HOST "docker restart mindtrip" 2>&1)

            if echo "$RESTART_RESULT" | grep -q "mindtrip"; then
              echo "  âœ“ Container restart command executed"
              echo "  Result: $RESTART_RESULT"
            else
              echo "  âŒ Container restart failed"
              echo "  Error: $RESTART_RESULT"
              exit 1
            fi

            # ç­‰å¾…å®¹å™¨å¯åŠ¨
            echo "â³ Waiting for container to start..."
            sleep 15

            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            echo "ğŸ” Checking container status..."
            CONTAINER_STATUS=$(ssh $SSH_OPTS $DEV_SSH_USERNAME@$DEV_SSH_HOST "docker ps --filter 'name=mindtrip' --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'" 2>/dev/null)

            if echo "$CONTAINER_STATUS" | grep -q "mindtrip.*Up"; then
              echo "  âœ… Container is running successfully"
              echo "  Container info:"
              echo "$CONTAINER_STATUS"
            else
              echo "  âš ï¸ Container status check failed"
              echo "  Current status:"
              ssh $SSH_OPTS $DEV_SSH_USERNAME@$DEV_SSH_HOST "docker ps -a | grep mindtrip" 2>/dev/null || echo "Container not found"
              echo ""
              echo "ğŸ” Manual verification:"
              echo "   SSH to server and run: docker ps | grep mindtrip"
              echo "   Check logs: docker logs mindtrip"
            fi

        # ===== Stage 6: æ¸…ç†å¤‡ä»½æ–‡ä»¶ =====
        - name: æ¸…ç†å¤‡ä»½æ–‡ä»¶
          script: |
            echo "ğŸ§¹ Cleaning up backup files..."

            # æ¸…ç†æœåŠ¡å™¨ä¸Šçš„æ—§å¤‡ä»½æ–‡ä»¶ï¼ˆä¿ç•™æœ€è¿‘ 5 ä¸ªï¼‰
            echo "ğŸ—‘ï¸ Cleaning up old JAR backup files..."
            ssh $SSH_OPTS $DEV_SSH_USERNAME@$DEV_SSH_HOST "cd /root/mindfront/work/project/mindtrip_server && ls -t yudao-server.jar.backup.* 2>/dev/null | tail -n +6 | xargs -r rm -f && echo 'Old backups cleaned up' || echo 'No old backups to clean'"

            echo "âœ… Cleanup completed"

        # ===== Stage 7: éƒ¨ç½²æ€»ç»“ =====
        - name: éƒ¨ç½²æ€»ç»“
          script: |
            echo ""
            echo "=========================================="
            echo "ğŸ‰ æµ‹è¯•ç¯å¢ƒåç«¯æœåŠ¡éƒ¨ç½²å®Œæˆ"
            echo "=========================================="
            echo "ğŸ“¦ é¡¹ç›®: RuoYi-Vue-Pro Backend"
            echo "ğŸŒ ç¯å¢ƒ: æµ‹è¯•ç¯å¢ƒ (Development)"
            echo "ğŸ–¥ï¸ æœåŠ¡å™¨: $DEV_SSH_HOST"
            echo "ğŸ³ å®¹å™¨: mindtrip"
            echo "â° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="
            echo ""
            echo "ğŸ“‹ éƒ¨ç½²æ–¹å¼ï¼š"
            echo "  1. æ„å»º JAR æ–‡ä»¶"
            echo "  2. å¤‡ä»½å½“å‰ JAR æ–‡ä»¶"
            echo "  3. ç›´æ¥æ›¿æ¢ /root/mindfront/work/project/mindtrip_server/yudao-server.jar"
            echo "  4. é‡å¯ Docker å®¹å™¨: docker restart mindtrip"
            echo ""
            echo "ğŸ”§ åº”ç”¨ä¿¡æ¯ï¼š"
            echo "  åº”ç”¨ç±»å‹: Spring Boot Java åº”ç”¨"
            echo "  å®¹å™¨åç§°: mindtrip"
            echo "  é•œåƒ: bitnamilegacy/java:17"
            echo "  ç«¯å£: 48080"
            echo "  æŒ‚è½½ç›®å½•: /root/mindfront/work/project/mindtrip_server -> /app"
            echo "  é…ç½®æ–‡ä»¶: application-dev.yaml"
            echo ""
            echo "ğŸ“‹ ç®¡ç†å‘½ä»¤ï¼š"
            echo "  æŸ¥çœ‹çŠ¶æ€: docker ps | grep mindtrip"
            echo "  æŸ¥çœ‹æ—¥å¿—: docker logs mindtrip"
            echo "  é‡å¯æœåŠ¡: docker restart mindtrip"
            echo "  æŸ¥çœ‹ JAR æ–‡ä»¶: ls -lh /root/mindfront/work/project/mindtrip_server/yudao-server.jar"
            echo "  æŸ¥çœ‹å¤‡ä»½: ls -lh /root/mindfront/work/project/mindtrip_server/yudao-server.jar.backup.*"
            echo "=========================================="

# ==================== ç”Ÿäº§ç¯å¢ƒè¯´æ˜ ====================
# æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²åœ¨ç‹¬ç«‹æœåŠ¡å™¨ä¸Šï¼Œä¸ä½¿ç”¨æ­¤ CI/CD é…ç½®
# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ­¥éª¤ï¼š
# 1. æ‰‹åŠ¨æ„å»ºï¼šmvn clean install -Dmaven.test.skip=true -Dspring.profiles.active=prod
# 2. æ‰‹åŠ¨ä¸Šä¼  JAR æ–‡ä»¶åˆ°ç”Ÿäº§æœåŠ¡å™¨
# 3. é‡å¯ç”Ÿäº§ç¯å¢ƒå®¹å™¨ï¼šdocker restart mindtrip-prod
#
# ç”Ÿäº§ç¯å¢ƒä¿¡æ¯ï¼š
# - æœåŠ¡å™¨ï¼šç‹¬ç«‹çš„ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨
# - å®¹å™¨åç§°ï¼šmindtrip-prod
# - é•œåƒï¼šbitnamilegacy/java:17
# - ç«¯å£ï¼š48080
# - é…ç½®æ–‡ä»¶ï¼šapplication-prod.yaml