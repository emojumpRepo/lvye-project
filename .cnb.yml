# CNB äº‘åŸç”Ÿæ„å»ºé…ç½® - èŠ‹é“ RuoYi-Vue-Pro åç«¯é¡¹ç›®
#
# é¡¹ç›®ç»“æ„ï¼šSpring Boot + Maven å¤šæ¨¡å—é¡¹ç›®
# ä¸»è¦æ¨¡å—ï¼š
#   - mindtrip-server: ä¸»åº”ç”¨æœåŠ¡å™¨
#   - mindtrip-module-*: å„ä¸šåŠ¡æ¨¡å—
#   - mindtrip-framework*: æ¡†æ¶æ‰©å±•
#
# åˆ†æ”¯ç­–ç•¥ï¼š
#   - develop-web: æµ‹è¯•ç¯å¢ƒæ„å»ºå’Œéƒ¨ç½²
#
# å‚è€ƒ: https://cnb.cool/examples/ecosystem/springboot-maven-ssh
# ç¼“å­˜ä¼˜åŒ–æ–‡æ¡£: https://docs.cnb.cool/zh/build/pipeline-cache.html

# ==================== æµ‹è¯•ç¯å¢ƒ - åç«¯æœåŠ¡ (SSH éƒ¨ç½²) ====================
develop-web:
  push:
    - name: æ„å»º Spring Boot åº”ç”¨
      services:
        - docker
      env:
        JAVA_VERSION: 17
      # å¯¼å…¥ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶ï¼ˆç”¨äº SSH éƒ¨ç½²ï¼‰
      imports:
        - https://cnb.cool/mindfront/psychology/deploy-credentials/-/blob/main/mindtrip-psychology-dev-envs.yml

      stages:
        - name: è®¾ç½®æ„å»ºç¯å¢ƒ
          script: |
            apt-get update -qq
            apt-get install -y -qq openjdk-${JAVA_VERSION}-jdk maven

            export JAVA_HOME=/usr/lib/jvm/java-${JAVA_VERSION}-openjdk-amd64
            export PATH=$JAVA_HOME/bin:$PATH

            java -version
            mvn -version

        - name: Maven æ„å»º
          script: |
            export JAVA_HOME=/usr/lib/jvm/java-${JAVA_VERSION}-openjdk-amd64
            export PATH=$JAVA_HOME/bin:$PATH
            # ä»æ ¹ç›®å½•æ„å»ºæ•´ä¸ªé¡¹ç›®ï¼ˆå¹¶è¡Œæ„å»º + æ‰¹å¤„ç†æ¨¡å¼ + ç¦ç”¨ä¼ è¾“è¿›åº¦ï¼‰
            mvn clean install \
              -Dmaven.test.skip=true \
              -Dmaven.compile.fork=true \
              -T 1C \
              --batch-mode \
              --no-transfer-progress

        # è°ƒè¯•ç¯å¢ƒå˜é‡
        - name: è°ƒè¯•ç¯å¢ƒå˜é‡
          script: |
            echo "ğŸ” æ£€æŸ¥ç¯å¢ƒå˜é‡..."
            echo "DEV_SSH_HOST: ${DEV_SSH_HOST:-<æœªè®¾ç½®>}"
            echo "DEV_SSH_USERNAME: ${DEV_SSH_USERNAME:-<æœªè®¾ç½®>}"
            echo "DEV_SSH_PORT: ${DEV_SSH_PORT:-<æœªè®¾ç½®>}"
            echo "DEV_SSH_PRIVATE_KEY: ${DEV_SSH_PRIVATE_KEY:+<å·²è®¾ç½®>-é•¿åº¦$(echo ${DEV_SSH_PRIVATE_KEY} | wc -c)}"
            echo ""
            echo "ğŸ” æ£€æŸ¥æ‰€æœ‰ç¯å¢ƒå˜é‡..."
            echo "æ‰€æœ‰ç¯å¢ƒå˜é‡æ•°é‡: $(env | wc -l)"
            echo ""
            echo "åŒ…å«å…³é”®è¯çš„ç¯å¢ƒå˜é‡:"
            env | grep -E "(DEV_SSH|DEV_|SSH)" | sort || echo "  æœªæ‰¾åˆ°ç›¸å…³ç¯å¢ƒå˜é‡"
            echo ""
            echo "ğŸ” æ£€æŸ¥ CNB ç‰¹å®šå˜é‡..."
            env | grep -i cnb | head -10 || echo "  æœªæ‰¾åˆ° CNB ç›¸å…³å˜é‡"
            echo ""
            echo "ğŸ” å½“å‰ä»“åº“ä¿¡æ¯:"
            echo "CNB_REPO: ${CNB_REPO:-<æœªè®¾ç½®>}"
            echo "CNB_BRANCH: ${CNB_BRANCH:-<æœªè®¾ç½®>}"

        # ä½¿ç”¨ rsync ä¸Šä¼  JAR æ–‡ä»¶å¹¶é‡å¯å®¹å™¨
        - name: éƒ¨ç½²åç«¯æœåŠ¡
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åç«¯æœåŠ¡..."
            echo "ğŸ“¦ é¡¹ç›®: RuoYi-Vue-Pro Backend"
            echo "ğŸ–¥ï¸ æœåŠ¡å™¨: ${DEV_SSH_HOST:-<æœªè®¾ç½®>}"
            echo "ğŸ‘¤ ç”¨æˆ·å: ${DEV_SSH_USERNAME:-<æœªè®¾ç½®>}"
            echo "ğŸ”Œ ç«¯å£: ${DEV_SSH_PORT:-22}"
            echo "â° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo ""

            # æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
            if [ -z "${DEV_SSH_HOST}" ] || [ -z "${DEV_SSH_USERNAME}" ] || [ -z "${DEV_SSH_PRIVATE_KEY}" ]; then
              echo "âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡"
              echo "   DEV_SSH_HOST: ${DEV_SSH_HOST:-<æœªè®¾ç½®>}"
              echo "   DEV_SSH_USERNAME: ${DEV_SSH_USERNAME:-<æœªè®¾ç½®>}"
              echo "   DEV_SSH_PRIVATE_KEY: ${DEV_SSH_PRIVATE_KEY:+<æœªè®¾ç½®>}"
              exit 1
            fi

            # å®‰è£… SSH å®¢æˆ·ç«¯å’Œ rsync
            echo "ğŸ“¦ å®‰è£…éƒ¨ç½²å·¥å…·..."
            apt-get update -qq && apt-get install -y -qq openssh-client rsync > /dev/null

            # é…ç½® SSH ç§é’¥
            mkdir -p ~/.ssh
            echo "$DEV_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa

            # é…ç½® SSH é€‰é¡¹
            SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/id_rsa -p ${DEV_SSH_PORT:-22}"

            # æµ‹è¯• SSH è¿æ¥
            echo "ğŸ”Œ æµ‹è¯• SSH è¿æ¥..."
            if ssh $SSH_OPTS $DEV_SSH_USERNAME@$DEV_SSH_HOST "echo 'SSH connection test successful'" 2>/dev/null; then
              echo "  âœ“ SSH è¿æ¥éªŒè¯æˆåŠŸ"
            else
              echo "  âœ— SSH è¿æ¥å¤±è´¥"
              exit 1
            fi

            # éªŒè¯ JAR æ–‡ä»¶å­˜åœ¨
            JAR_FILE="./mindtrip-server/target/mindtrip-server.jar"
            if [ ! -f "$JAR_FILE" ]; then
              echo "âŒ JAR æ–‡ä»¶æœªæ‰¾åˆ°: $JAR_FILE"
              exit 1
            fi

            # è®¾ç½®éƒ¨ç½²è·¯å¾„ï¼ˆæ ¹æ®åç«¯é¡¹ç›®çš„å®é™…è·¯å¾„ï¼‰
            TARGET_JAR="/root/mindfront/work/project/mindtrip_server/mindtrip-server.jar"

            echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
            echo "  æœ¬åœ°æ–‡ä»¶: $JAR_FILE"
            echo "  æ–‡ä»¶å¤§å°: $(stat -c%s "$JAR_FILE" | awk '{printf "%.1f MB", $1/1024/1024}')"
            echo "  ç›®æ ‡æœåŠ¡å™¨: ${DEV_SSH_USERNAME}@${DEV_SSH_HOST}:${DEV_SSH_PORT:-22}"
            echo "  ç›®æ ‡è·¯å¾„: $TARGET_JAR"
            echo ""

            # è¿œç¨‹å‡†å¤‡ï¼šå¤‡ä»½å½“å‰ JAR æ–‡ä»¶
            echo "ğŸ”§ è¿œç¨‹å‡†å¤‡..."
            ssh $SSH_OPTS $DEV_SSH_USERNAME@$DEV_SSH_HOST "
              # åˆ›å»ºéƒ¨ç½²ç›®å½•
              mkdir -p \$(dirname \"$TARGET_JAR\")
              echo \"  âœ“ åˆ›å»ºç›®å½•: \$(dirname \"$TARGET_JAR\")\"

              # å¤‡ä»½å½“å‰ JAR æ–‡ä»¶
              if [ -f \"$TARGET_JAR\" ]; then
                cp \"$TARGET_JAR\" \"$TARGET_JAR.backup.\$(date +%Y%m%d_%H%M%S)\"
                echo \"  âœ“ å¤‡ä»½åˆ›å»ºæˆåŠŸ\"
              else
                echo \"  â„¹ï¸ æ²¡æœ‰ç°æœ‰ JAR æ–‡ä»¶éœ€è¦å¤‡ä»½\"
              fi
            "

            # ä½¿ç”¨ rsync ä¸Šä¼  JAR æ–‡ä»¶
            echo "ğŸ“¤ å¼€å§‹ä¸Šä¼  JAR æ–‡ä»¶..."
            rsync -avz --progress \
              -e "ssh $SSH_OPTS" \
              "$JAR_FILE" \
              $DEV_SSH_USERNAME@$DEV_SSH_HOST:$TARGET_JAR

            if [ $? -eq 0 ]; then
              echo "âœ… JAR æ–‡ä»¶ä¸Šä¼ æˆåŠŸ"
            else
              echo "âŒ JAR æ–‡ä»¶ä¸Šä¼ å¤±è´¥"
              exit 1
            fi

            # éªŒè¯ä¸Šä¼ çš„æ–‡ä»¶å¹¶é‡å¯å®¹å™¨
            echo "ğŸ” éªŒè¯ä¸Šä¼ æ–‡ä»¶å¹¶é‡å¯æœåŠ¡..."
            ssh $SSH_OPTS $DEV_SSH_USERNAME@$DEV_SSH_HOST "
              # éªŒè¯æ–‡ä»¶
              if [ -f \"$TARGET_JAR\" ]; then
                echo \"âœ… æ–‡ä»¶éªŒè¯æˆåŠŸ\"
                ls -lh \"$TARGET_JAR\"
              else
                echo \"âŒ æ–‡ä»¶éªŒè¯å¤±è´¥\"
                exit 1
              fi

              # é‡å¯ Docker å®¹å™¨
              echo \"ğŸ”„ é‡å¯ Docker å®¹å™¨...\"
              docker restart mindtrip

              # ç­‰å¾…å®¹å™¨å¯åŠ¨
              echo \"â³ ç­‰å¾…å®¹å™¨å¯åŠ¨...\"
              sleep 15

              # æ£€æŸ¥å®¹å™¨çŠ¶æ€
              echo \"ğŸ” æ£€æŸ¥å®¹å™¨çŠ¶æ€...\"
              docker ps --filter \"name=mindtrip\" --format \"table {{.Names}}\t{{.Status}}\t{{.Ports}}\"

              # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘ 5 ä¸ªï¼‰
              echo \"ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶...\"
              cd \"\$(dirname \"$TARGET_JAR\")\" && ls -t mindtrip-server.jar.backup.* 2>/dev/null | tail -n +6 | xargs -r rm -f

              echo \"\"
              echo \"==========================================\"
              echo \"ğŸ‰ æµ‹è¯•ç¯å¢ƒåç«¯æœåŠ¡éƒ¨ç½²å®Œæˆ\"
              echo \"==========================================\"
              echo \"ğŸ“¦ é¡¹ç›®: RuoYi-Vue-Pro Backend\"
              echo \"ğŸ–¥ï¸ æœåŠ¡å™¨: ${DEV_SSH_HOST}\"
              echo \"ğŸ³ å®¹å™¨: mindtrip\"
              echo \"ğŸ“‚ è·¯å¾„: $TARGET_JAR\"
              echo \"â° æ—¶é—´: \$(date '+%Y-%m-%d %H:%M:%S')\"
              echo \"==========================================\"
            "

            echo ""
            echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆï¼"
            echo ""
            echo "ğŸ“‹ éƒ¨ç½²æ‘˜è¦ï¼š"
            echo "  âœ… æ„å»º JAR æ–‡ä»¶"
            echo "  âœ… ä½¿ç”¨ rsync ä¸Šä¼  JAR æ–‡ä»¶"
            echo "  âœ… å¤‡ä»½å½“å‰ JAR æ–‡ä»¶"
            echo "  âœ… é‡å¯ Docker å®¹å™¨"
            echo ""
            echo "ğŸ”§ åº”ç”¨ä¿¡æ¯ï¼š"
            echo "  åº”ç”¨ç±»å‹: Spring Boot Java åº”ç”¨"
            echo "  å®¹å™¨åç§°: mindtrip"
            echo "  é•œåƒ: bitnamilegacy/java:17"
            echo "  ç«¯å£: 48080"
            echo "  æŒ‚è½½ç›®å½•: /root/mindfront/work/project/mindtrip_server -> /app"
            echo "  é…ç½®æ–‡ä»¶: application-dev.yaml"
            echo ""
            echo "ğŸ“‹ ç®¡ç†å‘½ä»¤ï¼š"
            echo "  æŸ¥çœ‹çŠ¶æ€: docker ps | grep mindtrip"
            echo "  æŸ¥çœ‹æ—¥å¿—: docker logs mindtrip"
            echo "  é‡å¯æœåŠ¡: docker restart mindtrip"
            echo "  æŸ¥çœ‹ JAR æ–‡ä»¶: ls -lh /root/mindfront/work/project/mindtrip_server/mindtrip-server.jar"
            echo "  æŸ¥çœ‹å¤‡ä»½: ls -lh /root/mindfront/work/project/mindtrip_server/mindtrip-server.jar.backup.*"
            echo ""

# ==================== ç”Ÿäº§ç¯å¢ƒè¯´æ˜ ====================
# æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²åœ¨ç‹¬ç«‹æœåŠ¡å™¨ä¸Šï¼Œä¸ä½¿ç”¨æ­¤ CI/CD é…ç½®
# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ­¥éª¤ï¼š
# 1. æ‰‹åŠ¨æ„å»ºï¼šmvn clean install -Dmaven.test.skip=true -Dspring.profiles.active=prod
# 2. æ‰‹åŠ¨ä¸Šä¼  JAR æ–‡ä»¶åˆ°ç”Ÿäº§æœåŠ¡å™¨
# 3. é‡å¯ç”Ÿäº§ç¯å¢ƒå®¹å™¨ï¼šdocker restart mindtrip-prod
#
# ç”Ÿäº§ç¯å¢ƒä¿¡æ¯ï¼š
# - æœåŠ¡å™¨ï¼šç‹¬ç«‹çš„ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨
# - å®¹å™¨åç§°ï¼šmindtrip-prod
# - é•œåƒï¼šbitnamilegacy/java:17
# - ç«¯å£ï¼š48080
# - é…ç½®æ–‡ä»¶ï¼šapplication-prod.yaml